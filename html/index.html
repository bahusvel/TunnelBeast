<html>

<head>
	<meta charset="utf-8">
	<style>
		@import url(https://fonts.googleapis.com/css?family=Roboto:300);

		.login-page {
			width: 360px;
			padding: 8% 0 0;
			margin: auto;
		}

		.white-boxed {
			position: relative;
			z-index: 1;
			background: #FFFFFF;
			max-width: 360px;
			margin: 0 auto 100px;
			padding: 20px;
			text-align: center;
			box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
		}

		.grey-field {
			font-family: "Roboto", sans-serif;
			outline: 0;
			background: #f2f2f2;
			width: 100%;
			border: 0;
			margin: 0 0 15px;
			padding: 10px;
			box-sizing: border-box;
			font-size: 12px;
		}

		.errorMessage {
			font-family: "Roboto", sans-serif;
			outline: 0;
			width: 100%;
			color: #AB0000;
			font-size: 14px;
		}

		form {
			position: relative;
			z-index: 1;
			background: #FFFFFF;
			max-width: 360px;
			margin: 0 auto 100px;
			padding: 20px;
			text-align: center;
			box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.2), 0 5px 5px 0 rgba(0, 0, 0, 0.24);
		}

		input {
			font-family: "Roboto", sans-serif;
			outline: 0;
			background: #f2f2f2;
			width: 100%;
			border: 0;
			margin: 0 0 15px;
			padding: 15px;
			box-sizing: border-box;
			font-size: 14px;
		}

		input:invalid {
			box-shadow: 0 0 5px 0 rgba(255, 0, 0, 0.9)
		}

		select {
			font-family: "Roboto", sans-serif;
			outline: 0;
			background: #f2f2f2;
			width: 100%;
			border: 0;
			margin: 0 0 15px;
			padding: 15px;
			box-sizing: border-box;
			font-size: 14px;
		}

		button {
			font-family: "Roboto", sans-serif;
			text-transform: uppercase;
			outline: 0;
			background: #4CAF50;
			width: 100%;
			border: 0;
			padding: 15px;
			color: #FFFFFF;
			font-size: 14px;
			-webkit-transition: all 0.3 ease;
			transition: all 0.3 ease;
			cursor: pointer;
		}

		.delete-button {
			font-family: "Roboto", sans-serif;
			text-transform: uppercase;
			outline: 0;
			background: #4CAF50;
			width: 10%;
			border: 0;
			margin-left: 10px;
			padding: 10px;
			color: #FFFFFF;
			font-size: 14px;
			-webkit-transition: all 0.3 ease;
			transition: all 0.3 ease;
			cursor: pointer;
			display: inline-block;
		}

		body {
			background: #76b852;
			/* fallback for old browsers */
			background: -webkit-linear-gradient(right, #76b852, #8DC26F);
			background: -moz-linear-gradient(right, #76b852, #8DC26F);
			background: -o-linear-gradient(right, #76b852, #8DC26F);
			background: linear-gradient(to left, #76b852, #8DC26F);
			font-family: "Roboto", sans-serif;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}
	</style>
</head>

<body>
	<script type="text/javascript">
		var USERNAME = "";
		var PASSWORD = "";
		var ROUTES = [];
		var map = {
			"ERROR ACCESS DENIED" : "Access denied. Please contact your administrator. <br/><br/>",
			"ERROR EXISTS" : "Routes exists. Please check your input data. <br/><br/>",
			"ERROR PORT OCCUPIED" : "Port occupied. Please try another port. <br/><br/>",
			"ERROR INPUT" : "Input error. Please check your input data. <br/><br/>",
			"ERROR AUTH" : "Incorrect user ID or password. <br/><br/>",
			"ERROR NOT EXIST" : "The route you try to delete is not exist.<br/><br/>"
		};

		function create(htmlStr) {
			var frag = document.createDocumentFragment(),
				temp = document.createElement('div');
			temp.innerHTML = htmlStr;
			while (temp.firstChild) {
				frag.appendChild(temp.firstChild);
			}
			return frag;
		}

		function deleteRoute(index) {
			var route = ROUTES[index];

			console.log(route);

			var params = `username=${USERNAME}&password=${PASSWORD}&sourceip=${route.SourceIP}&internalip=${route.DestinationIP}&externalport=${route.ExternalPort}&internalport=${route.InternalPort}`;

			var xhr = new XMLHttpRequest();
			var delErrorElement = document.getElementById("deleteRouteError");

			xhr.open('POST', "/delete", false);
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

			xhr.onreadystatechange = function() {
				if (xhr.readyState == 4 && xhr.status == 200) {
					document.getElementById("addRouteError").setAttribute("hidden", "true");

					if (xhr.responseText == "OK") {
						delErrorElement.setAttribute("hidden", "true");
						return;
					}

					if (!(xhr.responseText in map)){
						delErrorElement.removeAttribute("hidden");
						delErrorElement.innerHTML = "Route delete failed. Please try again. <br/><br/>";
						return;
					}

					delErrorElement.removeAttribute("hidden");
					delErrorElement.innerHTML = map[xhr.responseText];
				}
			}

			xhr.send(params);

			console.log(xhr.responseText);

			refresh();
			return false;
		}

		function showRoute(route, index) {
			var html =
				`<div class="grey-field">
									<p style="display:inline">
									${route.SourceIP} -> ${route.ExternalPort}:${route.DestinationIP}:${route.InternalPort}
									</p>
									<div class="delete-button" onclick="deleteRoute(${index});">
									-
									</div>
						</div>`

			var fragment = create(html);
			document.getElementById("routes").appendChild(fragment);
		}

		function addRoute(form) {
			var internalip = form.internalip.value;
			var externalport = form.externalport.value;
			var internalport = form.internalport.value;
			var error = "";

			if (internalip.length == 0) {
				error += 'Internal IP is required\n';
			}
			if (internalport.length == 0) {
				error += 'Internal Port is required\n';
			}
			if (error) {
				alert(error);
				return false;
			}

			var params = `username=${USERNAME}&password=${PASSWORD}&internalip=${internalip}&externalport=${externalport}&internalport=${internalport}`;
			var xhr = new XMLHttpRequest();
			var addErrorElement = document.getElementById("addRouteError");

			xhr.open('POST', "/add", false);
			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

			xhr.onreadystatechange = function() {
				if (xhr.readyState == 4 && xhr.status == 200) {
					document.getElementById("deleteRouteError").setAttribute("hidden", "true");

					if (xhr.responseText == "OK") {
						addErrorElement.setAttribute("hidden", "true");
						return;
					}

					if (!(xhr.responseText in map)){
						addErrorElement.removeAttribute("hidden");
						addErrorElement.innerHTML = "Route add failed. Please check the input data. <br/><br/>";
						return;
					}

					addErrorElement.removeAttribute("hidden");
					addErrorElement.innerHTML = map[xhr.responseText];
				}
			}

			xhr.send(params);
			refresh();
			return false;
		}

		function logoutForm(form) {
			USERNAME = "";
			PASSWORD = "";
			document.getElementById("route-float").setAttribute("hidden", "true");
			document.getElementById("mapform").setAttribute("hidden", "true");
			document.getElementById("login-form").removeAttribute("hidden");
			document.getElementById("logout-form").setAttribute("hidden", "true");
			return false;
		}

		function fetchRoutes() {
			var params = `username=${USERNAME}&password=${PASSWORD}`;

			var xhr = new XMLHttpRequest();
			xhr.open('POST', "/list", false);


			xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xhr.send(params);
			console.log(xhr.responseText);
			var routes = JSON.parse(xhr.responseText);

			ROUTES = routes;

			var node = document.getElementById("routes");
			while (node.hasChildNodes()) {
				node.removeChild(node.lastChild);
			}

			for (var i = 0; i < routes.length; i++) {
				showRoute(routes[i], i);
			}
		}

		function getPorts() {
			var xhr = new XMLHttpRequest();
			xhr.open('GET', "/ports", false);
			xhr.send();

			console.log(xhr.responseText);

			var ports = JSON.parse(xhr.responseText);

			var node = document.getElementById("port-select")

			while (node.hasChildNodes()) {
				node.removeChild(node.lastChild);
			}

			for (var i = 0; i < ports.length; i++) {
				var frag = create(`<option value="${ports[i]}">${ports[i]}</option>`)
				node.appendChild(frag);
			}
		}

		function refresh() {
			getPorts();
			fetchRoutes();
		}

		function loginForm(form) {
			var error = "";
			var username = form.username.value;
			var password = form.password.value;
			if (username.length == 0) {
				error += 'Username is required\n';
			}
			if (password.length == 0) {
				error += 'Password is required\n';
			}
			if (error) {
				alert(error);
				return false;
			}
			var http = new XMLHttpRequest();
			var url = "/auth";
			var params = `username=${username}&password=${password}`;
			http.open("POST", url, true);
			http.setRequestHeader("Content-type",
				"application/x-www-form-urlencoded");
			http.onreadystatechange = function() {
				if (http.readyState == 4 && http.status == 200) {
					if (http.responseText == "OK") {
						USERNAME = username;
						PASSWORD = password;
						document.getElementById("login-form").setAttribute("hidden",
							"true");
						document.getElementById("route-float").removeAttribute("hidden");
						document.getElementById("logout-form").removeAttribute("hidden");
						document.getElementById("mapform").removeAttribute("hidden");
						console.log("Auth success");
						refresh();
					} else if (http.responseText == "ERROR AUTH") {
						console.log("Auth failed");
						document.getElementById("authFail").removeAttribute("hidden");
						document.getElementById("authFail").innerHTML = map[http.responseText];
					}
				}
			}
			http.send(params);
			return false;
		}
	</script>

	<div class="login-page">

		<form action="#" onsubmit="return loginForm(this);" id="login-form">
			<label hidden="true" class="errorMessage" id="authFail" for></label>
			<input type="text" name="username" placeholder="Username" />
			<input type="password" name="password" placeholder="Password" />
			<button type="submit">login</button>
			<p>Powered by <a href="https://github.com/bahusvel/TunnelBeast">TunnelBeast</a></p>
		</form>

		<div class="white-boxed" id="route-float" hidden="true">
			Current Routes:
			<br/>
			<div id="routes">
			</div>
			<label hidden="true" class="errorMessage" id="deleteRouteError" for></label>
		</div>


		<form action="#" onsubmit="return addRoute(this);" id="mapform" hidden="true">
			<label hidden="true" class="errorMessage" id="addRouteError" for></label>
			<input type="text" name="internalip" placeholder="Internal IP" title="Internal IP Address: X . X . X . X"
				pattern="((^|\.)((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]?\d))){4}$"/>
			<input type="text" name="internalport" placeholder="Internal Port" title="Internal Port range: 0 ~ 65535"
				pattern="^([0-9]{1,4}|[1-5][0-9]{4}|6[0-4][0-9]{3}|65[0-4][0-9]{2}|655[0-2][0-9]|6553[0-5])$"/>
			Select external port:
			<select name="externalport" form="mapform" id="port-select">
			</select>
			<button type="submit">Add</button>
		</form>

		<form action="#" onsubmit="return logoutForm(this);" hidden="true" id="logout-form">
			<button type="submit">LOGOUT</button>
		</form>

	</div>
	</div>
</body>

</html>
