<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>TunnelBeast</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>





    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <script type="text/javascript">
        var USERNAME = "";
        var PASSWORD = "";
        var ROUTES = [];

        function create(htmlStr) {
            var frag = document.createDocumentFragment(),
                temp = document.createElement('div');
            temp.innerHTML = htmlStr;
            while (temp.firstChild) {
                frag.appendChild(temp.firstChild);
            }
            return frag;
        }

        function deleteRoute(index) {
            var route = ROUTES[index];

            console.log(route);

            var params = `username=${USERNAME}&password=${PASSWORD}&sourceip=${route.SourceIP}&internalip=${route.DestinationIP}&externalport=${route.ExternalPort}&internalport=${route.InternalPort}`;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', "http://tunnel.unitecloud.net:666/delete", false);

            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send(params);

            console.log(xhr.responseText);

            refresh();
            return false;
        }

        function showRoute(route, index) {
           
            

            var index = `${index}`;
            var locad = `${route.SourceIP}`;
            var locport = `${route.ExternalPort}`;
            var trgad = `${route.DestinationIP}`;
            var trgport =`${route.InternalPort}`;
            
            
            var routeline = '<tr><th scope="row">'+index+'</th><td>'+locport+'</td><td>'+trgad+'</td><td>'+trgport+'</td><td><button type="button" class="btn btn-secondary delete-button" onclick="deleteRoute('+index+');">Delete</button></td></tr>';
            $("#routes").append(routeline);

          //  var fragment = create(html);
          //  document.getElementById("routes").appendChild(fragment);
        }

        function addRoute(form) {
            var internalip = form.internalip.value;
            var externalport = form.externalport.value;
            var internalport = form.internalport.value;

            var params = `username=${USERNAME}&password=${PASSWORD}&internalip=${internalip}&externalport=${externalport}&internalport=${internalport}`;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', "http://tunnel.unitecloud.net:666/add", false);

            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send(params);

            refresh();
            return false;
        }

        function logoutForm(form) {
            USERNAME = "";
            PASSWORD = "";
            document.getElementById("app-body").setAttribute("hidden", "true");
            document.getElementById("logout-form").setAttribute("hidden", "true");
            document.getElementById("login-body").removeAttribute("hidden");
            return false;
        }

        function fetchRoutes() {
            var params = `username=${USERNAME}&password=${PASSWORD}`;

            var xhr = new XMLHttpRequest();
            xhr.open('POST', "http://tunnel.unitecloud.net:666/list", false);


            xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            xhr.send(params);
            console.log(xhr.responseText);
            var routes = JSON.parse(xhr.responseText);

            ROUTES = routes;

            var node = document.getElementById("routes")
            while (node.hasChildNodes()) {
                node.removeChild(node.lastChild);
            }

            for (var i = 0; i < routes.length; i++) {
                showRoute(routes[i], i);
            }
        }

        function getPorts() {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', "http://tunnel.unitecloud.net:666/ports", false);
            xhr.send();

            console.log(xhr.responseText);

            var ports = JSON.parse(xhr.responseText);

            var node = document.getElementById("port-select")

            while (node.hasChildNodes()) {
                node.removeChild(node.lastChild);
            }

            for (var i = 0; i < ports.length; i++) {
                var frag = create(`<option value="${ports[i]}">${ports[i]}</option>`)
                node.appendChild(frag);
            }
        }

        function refresh() {
            getPorts();
            fetchRoutes();
        }

        function loginForm(form) {
            var error = "";
            var username = form.username.value;
            var password = form.password.value;
            if (username.length == 0) {
                error += 'Username is required\n';
            }
            if (password.length == 0) {
                error += 'Password is required\n';
            }
            if (error) {
                alert(error);
                return false;
            }
            var http = new XMLHttpRequest();
            var url = "http://tunnel.unitecloud.net:666/auth";
            var params = `username=${username}&password=${password}`;
            http.open("POST", url, true);
            http.setRequestHeader("Content-type",
                "application/x-www-form-urlencoded");
            http.onreadystatechange = function() {
                if (http.readyState == 4 && http.status == 200) {
                    if (http.responseText == "OK") {
                        USERNAME = username;
                        PASSWORD = password;
                        document.getElementById("login-body").setAttribute("hidden",
                            "true");
                        document.getElementById("logout-form").removeAttribute("hidden");
                        document.getElementById("app-body").removeAttribute("hidden");
                        console.log("Auth success");
                        refresh();
                    } else if (http.responseText == "ERROR AUTH") {
                        console.log("Auth failed");
                    }
                }
            }
            http.send(params);
            return false;
        }

        $(function() {
            $('[data-toggle="popover"]').popover({
                container: 'body'
            })
        })

    </script>

    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">TunnelBeast</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Control Panel<span class="sr-only">(current)</span></a>
                    </li>
                </ul>
                <form class="form-inline my-2 my-lg-0" action="#" onsubmit="return logoutForm(this);" id="logout-form" hidden="true">
                    <button class="btn btn-outline-info my-2 my-sm-0" type="submit">LOGOUT</button>
                </form>
            </div>
        </nav>
        <!-- Header -->
        <div class="jumbotron jumbotron-fluid">
            <div class="container">
                <h1 class="display-3">TunnelBeast</h1>
                <p class="lead">TunnelBeast exposes an authentication portal (and HTTP API) to the world, through which the user must authenticate and select internal address to proxy into.</p>
            </div>
        </div>
        <!-- loginbody -->
        <div id='login-body' class='container'>
            <div class="row" align-items-center>
                <div class="col"></div>

                <div class="col">
                    <div class="card">
                        <h4 class="card-header">Login</h4>
                        <div class="card-body">
                            <form action="#" onsubmit="return loginForm(this);" id="login-form">
                                <div class="form-group row">
                                    <label for="username" class="col-sm-4 col-form-label">User Name</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" id="username" name="username">
                                    </div>

                                </div>
                                <div class="form-group row">
                                    <label for="password" class="col-sm-4 col-form-label">Password</label>
                                    <div class="col-sm-8">
                                        <input type="text" class="form-control" id="password" name="password">
                                    </div>

                                </div>


                                <p class="text-center"><button type="submit" class="btn btn-primary">Login</button></p>
                                <p class="text-center">Powered by <a href="https://github.com/bahusvel/TunnelBeast">TunnelBeast</a></p>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col"></div>
            </div>
        </div>
        <!-- app body -->
        <div id='app-body' class='container-fluid' hidden="true">
            <div class="row justify-content-center">
                <div id='app-body-left' class='col-2 '>
                    <h5>Please enter your target server info here</h5>
                    <form action="#" onsubmit="return addRoute(this);" id="mapform">
                        <div class="form-group">
                            <label for="InputTargetIP">Target IP Address</label>
                            <input type="text" class="form-control" id="InputTargetIP" name="internalip" aria-describedby="IPlHelp" placeholder="Enter IP like 192.168.1.1" data-container="body" data-toggle="popover" data-placement="top" data-content="Please enter the internal IP address of the server you want to link to.">
                        </div>
                        <div class="form-group">
                            <label for="PortSelect">Target Port</label>
                            <input class="form-control" id="PortSelect" aria-describedby="PortlHelp" name="internalport">
                            <small id="PortlHelp" class="form-text text-muted">Input the port of the target server</small>
                        </div>
                        <div class="form-group">
                            <label for="LocalPortSelect">Local Port Select</label>
                            <select class="form-control" name="externalport" form="mapform" id="port-select" aria-describedby="LocalPortHelp">

                            </select>
                            <small id="LocalPortlHelp" class="form-text text-muted">Choose a port</small>
                        </div>

                        <button type="submit" class="btn btn-primary">Add</button>
                    </form>
                </div>
                <div id='app-body-right' class='col-6'>

                    <div class="card card-body" id="IPList">
                        <h4 class="card-title">Current Routes</h4>
                        <table class="table table-hover" id="IPList">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Local Port</th>
                                    <th>Target IP Address</th>
                                    <th>Target Port</th>
                                    <th>Functions</th>
                                </tr>
                            </thead>
                            <tbody id="routes">

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </body>
